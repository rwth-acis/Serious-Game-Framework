module.exports = function (router, options, dbProvider) {
    options = options || {};
    var apiRoot = options.apiRoot || '/';
    var collectorRoot = options.collectorRoot || '/';

    var versions = require('./versions');
    var games = require('./games');
    var collector = require('./collector');
    var users = require('./users');
    var rtResults = require('./rt-results');
    var versionsResults = require('./versions-results');
    var statements = require('./statements');
    var authTokens = require('./auth-tokens');
    var sessions = require('./sessions');
    var traces_ = require('./traces_');

    users.setSalt(options.passwordsSalt || '');

    var processResponse = function (promise, res) {
        promise.then(function (result) {
            res.json(result);
        }).fail(function (err) {
            if (err.stack) {
                console.log(err.stack);
            }

            if (err.status) {
                res.status(err.status);
                if (err.message) {
                    res.send(err.message);
                } else {
                    res.end();
                }
            } else {
                res.status(500).end();
            }
        });
    };

    var find = function (collection, createQuery) {
        return function (req, res) {
            var process = function (query) {
                processResponse(collection.find(query), res);
            };
            if (createQuery) {
                createQuery(req, process);
            } else {
                process({});
            }
        };
    };

    var findById = function (collection) {
        return function (req, res) {
            processResponse(collection.findById(req.params.id), res);
        };
    };

    var insert = function (collection, pre) {
        return function (req, res) {
            if (pre) {
                pre(req, res);
            }
            processResponse(collection.insert(req.body), res);
        };
    };

    var deleteById = function (collection) {
        return function (req, res) {
            processResponse(collection.removeById(req.params.id), res);
        };
    };

    var findAndModify = function (collection, pre) {
        return function (req, res) {
            if (req.body && req.body._id) {
                delete req.body._id;
            }

            if (pre) {
                pre(req, res);
            }

            processResponse(collection.findAndModify(req.params.id, req.body), res);
        };
    };

    // GET
    router.get(apiRoot + 'games', find(games));
    router.get(apiRoot + 'games/:gameId/versions', find(versions, function (req, callback) {
        callback({
            gameId: games.toObjectID(req.params.gameId)
        });
    }));
    router.get(apiRoot + 'users', find(users));
    router.get(apiRoot + 'games/:gameId/versions/:versionId/rt', find(rtResults, function (req, callback) {
        callback(versions.toObjectID(req.params.versionId));
    }));
    router.get(apiRoot + 'statements/', find(statements));
    router.get(apiRoot + 'online/', find(authTokens));

    // GET/id
    router.get(apiRoot + 'games/:id', findById(games));
    router.get(apiRoot + 'games/:gameId/versions/:id', findById(versions));
    router.get(apiRoot + 'users/:id', findById(users));
    router.get(apiRoot + 'games/:gameId/versions/:id/results', findById(versionsResults));
    router.get(apiRoot + 'sessions/:id', findById(sessions));


    // POST
    router.post(apiRoot + 'games', insert(games));
    router.post(apiRoot + 'games/:gameId/versions', insert(versions, function (req, res) {
        req.body.gameId = games.toObjectID(req.params.gameId);
    }));
    router.post(apiRoot + 'users', insert(users));

    // DELETE
    router.delete(apiRoot + 'games/:id', deleteById(games));
    router.delete(apiRoot + 'games/:gameId/versions/:id', deleteById(versions));
    router.delete(apiRoot + 'users/:id', deleteById(users));

    // POST/id
    router.post(apiRoot + 'games/:id', findAndModify(games));
    router.post(apiRoot + 'games/:gameId/versions/:id', findAndModify(versions, function (req, res) {
        if (req.body && req.body.gameId) {
            delete req.body.gameId;
        }
    }));
    router.post(apiRoot + 'users/:id', findAndModify(users));

    // MARKO Profile: Badges + Collect Traces + Highscore + Experience
    router.get(collectorRoot + 'profiles', function (req, res) {
        processResponse(collector.getProfile(req.headers.email), res);
    });
    router.post(collectorRoot + 'badges', function (req, res) {
        collector.addBadge(req.headers.email, req.headers.badge_path, dbProvider);
        res.status(200).end();
    });
    router.get(collectorRoot + 'traces', function (req, res) {
        processResponse(collector.queryTraces(req.headers.email, req.headers.statistic), res);
    });
    router.get(collectorRoot + 'traces/:gameID', function (req, res) {
        processResponse(collector.queryTraces(req.headers.email, null, req.params.gameID, req.headers.type), res);
    });
    router.get(collectorRoot + 'highscore', function (req, res) {
        processResponse(collector.highScore(req.headers.email), res);
    });
    router.get(collectorRoot + 'experience', function (req, res) {
        processResponse(collector.experience(req.headers.email), res);
    });
    // MARKO

    // Tracker
    router.post(collectorRoot + 'start/:trackingCode', function (req, res) {
        processResponse(collector.start(req.params.trackingCode, req.headers.authorization, req.headers.email), res);
    });

    router.post(collectorRoot + 'track', function (req, res) {
        // MARKO use email (which includes playerName and authToken) as authentification instead of authToken
        processResponse(collector.track(req.headers.email, req.body), res);
    });

    // Sessions
    router.post(apiRoot + 'sessions', function (req, res) {
        switch (req.query.event) {
            case 'start':
                processResponse(sessions.startSession(req.query.gameId, req.query.versionId), res);
                break;
            case 'end':
                processResponse(sessions.endSession(req.query.gameId, req.query.versionId), res);
                break;
            default:
                res.status(400).end();
                break;
        }
    });

    router.get(apiRoot + 'sessions/', function (req, res) {
        processResponse(sessions.getSessions(req.query.gameId, req.query.versionId), res);
    });

    router.get(apiRoot + 'sessions/:id/results', function (req, res) {
        processResponse(sessions.results(req.params.id), res);
    });

    router.post(apiRoot + 'sessions/:id/results/:resultId', function (req, res) {
        if (req.body && req.body._id) {
            delete req.body._id;
        }
        processResponse(sessions.updateResult(req.params.id, req.params.resultId, req.body), res);
    });

    // Login
    var loginPath = options.loginPath || '/';
    var redirectLogin = options.redirectLogin || '/';
    router.post(loginPath, function (req, res) {
        var name = req.body.name;
        var password = req.body.password;
        if (name && password) {
            users.login(name, password).then(function (user) {
                if (user) {
                    req.session.name = user.name;
                    req.session.role = user.role;
                    res.redirect(redirectLogin);
                } else {
                    res.redirect(loginPath + '?error=true');
                }
            });
        } else {
            res.redirect(loginPath + '?error=true');
        }
    });
};
